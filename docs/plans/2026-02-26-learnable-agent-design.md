# –û–±—É—á–∞–µ–º—ã–π –∞–≥–µ–Ω—Ç: –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ —É—Ç–æ—á–Ω–µ–Ω–∏–π + —Ä–µ–∑–æ–ª—é—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π

**–î–∞—Ç–∞:** 2026-02-26
**–°—Ç–∞—Ç—É—Å:** –£—Ç–≤–µ—Ä–∂–¥—ë–Ω

---

## –¶–µ–ª–∏

1. –ë–æ—Ç –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç —Å–≤–æ–∏ –æ—à–∏–±–∫–∏ ‚Äî –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Ç–æ—á–Ω—è–µ—Ç –≤–æ–ø—Ä–æ—Å, –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª–æ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–ª—è –±—É–¥—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
2. –ë–æ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç —à–∫–æ–ª—ã –∏ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ –≤ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π —Ñ–æ—Ä–º–µ, –∞ –ø—Ä–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏—è—Ö ‚Äî —É—Ç–æ—á–Ω—è–µ—Ç –∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ—Ç –º–∞–ø–ø–∏–Ω–≥

## –†–µ—à–µ–Ω–∏—è

- **–•—Ä–∞–Ω–∏–ª–∏—â–µ:** Supabase (–¥–≤–µ –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã)
- **–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª:** keyword-matching –ø–æ —Ç–µ–∫—Å—Ç—É –≤–æ–ø—Ä–æ—Å–∞ (–Ω–µ –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞ –≤ –∫–∞–∂–¥—ã–π –ø—Ä–æ–º–ø—Ç)
- **Scope:** –æ–±—â–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –Ω–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ú–æ–¥–µ—Ä–∞—Ü–∏—è:** —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∞ –≤ Telegram (inline-–∫–Ω–æ–ø–∫–∏)

---

## –•—Ä–∞–Ω–∏–ª–∏—â–µ

### –¢–∞–±–ª–∏—Ü–∞ `knowledge_rules`

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| id | serial | PK |
| category | text | `sql_pattern` / `domain_term` / `business_logic` |
| rule_text | text | –¢–µ–∫—Å—Ç –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è system prompt |
| keywords | text[] | –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è matching |
| source_question | text | –í–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–≤—ë–ª –∫ –ø—Ä–∞–≤–∏–ª—É |
| source_correction | text | –£—Ç–æ—á–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| created_by | bigint | Telegram user_id –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–∞ |
| approved_by | bigint | Telegram user_id –∞–¥–º–∏–Ω–∞ |
| status | text | `pending` / `approved` / `rejected` |
| created_at | timestamptz | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |

### –¢–∞–±–ª–∏—Ü–∞ `name_aliases`

| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| id | serial | PK |
| alias | text | –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª |
| canonical_name | text | –ö–∞–∫ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö |
| entity_type | text | `school` / `region` / `district` |
| status | text | `pending` / `approved` / `rejected` |
| created_at | timestamptz | –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è |

---

## Feature 1: –û–±—É—á–µ–Ω–∏–µ –∏–∑ —É—Ç–æ—á–Ω–µ–Ω–∏–π

### –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —É—Ç–æ—á–Ω–µ–Ω–∏—è

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ 2+ –≤–æ–ø—Ä–æ—Å –≤ —Å–µ—Å—Å–∏–∏, –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π LLM-–≤—ã–∑–æ–≤ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–∞—Ä—É —Å–æ–æ–±—â–µ–Ω–∏–π:

```
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∏–∞–ª–æ–≥. –ë—ã–ª–æ –ª–∏ –≤—Ç–æ—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ–º –∏–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ü–∏–µ–π –ø–µ—Ä–≤–æ–≥–æ?
–ï—Å–ª–∏ –¥–∞ ‚Äî —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –ø—Ä–∞–≤–∏–ª–æ:
{
  "is_correction": true,
  "rule_text": "–ö–æ–≥–¥–∞ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –ø—Ä–æ X, –Ω—É–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å Y",
  "keywords": ["x", "y"],
  "category": "sql_pattern|domain_term|business_logic"
}
–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –≤–µ—Ä–Ω–∏ {"is_correction": false}
```

### –û–¥–æ–±—Ä–µ–Ω–∏–µ –∞–¥–º–∏–Ω–æ–º

–ü—Ä–∏ `is_correction: true` –ø—Ä–∞–≤–∏–ª–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ `pending` –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω—É:

```
üìù –ù–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ –∏–∑ –¥–∏–∞–ª–æ–≥–∞:

–í–æ–ø—Ä–æ—Å: "–°–∫–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç –≤ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–µ?"
–£—Ç–æ—á–Ω–µ–Ω–∏–µ: "–Ø –∏–º–µ–ª –≤ –≤–∏–¥—É –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π, –Ω–µ –≥–æ—Ä–æ–¥"

–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ:
¬´–ö–æ–≥–¥–∞ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä" –±–µ–∑ —É—Ç–æ—á–Ω–µ–Ω–∏—è, —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å
–ø–æ region = '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π', –∞ –Ω–µ –ø–æ district¬ª

–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: –∫—Ä–∞—Å–Ω–æ–¥–∞—Ä, –∫—Ä–∞–π, —Ä–µ–≥–∏–æ–Ω

[‚úÖ –û–¥–æ–±—Ä–∏—Ç—å] [‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å] [‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å]
```

- "–û–¥–æ–±—Ä–∏—Ç—å" ‚Üí —Å—Ç–∞—Ç—É—Å `approved`, –ø—Ä–∞–≤–∏–ª–æ –≤ –∫–µ—à
- "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" ‚Üí –±–æ—Ç –ø—Ä–æ—Å–∏—Ç –≤–≤–µ—Å—Ç–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
- "–û—Ç–∫–ª–æ–Ω–∏—Ç—å" ‚Üí —Å—Ç–∞—Ç—É—Å `rejected`

### –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª –≤ –ø—Ä–æ–º–ø—Ç

–ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ ‚Äî keyword matching –ø–æ —Ç–µ–∫—Å—Ç—É –≤–æ–ø—Ä–æ—Å–∞. –¢–æ–ª—å–∫–æ —Å–æ–≤–ø–∞–≤—à–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –≤—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤ system prompt –∫–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–µ–∫—Ü–∏—è `## –ü—Ä–∞–≤–∏–ª–∞ –∏–∑ –æ–ø—ã—Ç–∞`.

–°—Ç–æ–∏–º–æ—Å—Ç—å: –æ–¥–∏–Ω –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π LLM-–≤—ã–∑–æ–≤ (~200 —Ç–æ–∫–µ–Ω–æ–≤) —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –≤ —Å–µ—Å—Å–∏–∏.

---

## Feature 2: –†–µ–∑–æ–ª—é—Ü–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π —à–∫–æ–ª –∏ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π

### –¢—Ä—ë—Ö—à–∞–≥–æ–≤—ã–π pipeline

**–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–ª–∏–∞—Å–æ–≤ –≤ –∫–µ—à–µ**

–ü–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π SQL –ø—Ä–æ–≤–µ—Ä—è–µ–º `name_aliases`. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω –∞–ª–∏–∞—Å ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç:

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–æ—Å–∏–ª: "–°–∫–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç –≤ —à–∫–æ–ª–µ 5 –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä?"
–ü–æ–¥—Å–∫–∞–∑–∫–∞: "—à–∫–æ–ª–∞ 5 –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä" = "–ú–ë–û–£ –°–û–® ‚Ññ5 –≥. –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä" –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
```

**–®–∞–≥ 2: Fuzzy-search –ø—Ä–∏ –ø—Ä–æ–º–∞—Ö–µ**

–ï—Å–ª–∏ –∞–ª–∏–∞—Å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏ SQL –≤–µ—Ä–Ω—É–ª 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Äî –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:

```sql
SELECT DISTINCT school FROM work_results_n
WHERE lower(school) LIKE '%—à–∫–æ–ª–∞%' AND lower(school) LIKE '%5%'
LIMIT 10
```

–ë–æ—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```
–ù–µ –Ω–∞—à—ë–ª —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è. –í—ã –∏–º–µ–ª–∏ –≤ –≤–∏–¥—É –æ–¥–Ω—É –∏–∑ —ç—Ç–∏—Ö —à–∫–æ–ª?
1. –ú–ë–û–£ –°–û–® ‚Ññ5 –≥. –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä
2. –ú–ë–û–£ –°–û–® ‚Ññ5 –≥. –ù–æ–≤–æ—Ä–æ—Å—Å–∏–π—Å–∫
3. –®–∫–æ–ª–∞ ‚Ññ5 –∏–º. –ì–µ—Ä–æ—è...
```

**–®–∞–≥ 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–ª–∏–∞—Å–∞**

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç ‚Üí –º–∞–ø–ø–∏–Ω–≥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `name_aliases` –∫–∞–∫ `pending` ‚Üí –∞–¥–º–∏–Ω –æ–¥–æ–±—Ä—è–µ—Ç. –í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ —Ä–µ–∑–æ–ª–≤–∏—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π (`region`, `district`).

---

## –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `knowledge/store.py` | `KnowledgeStore` ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ, keyword-matching –ø—Ä–∞–≤–∏–ª –∏ –∞–ª–∏–∞—Å–æ–≤ |
| `knowledge/extractor.py` | `extract_rule()` ‚Äî LLM-–≤—ã–∑–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —É—Ç–æ—á–Ω–µ–Ω–∏–π |
| `knowledge/resolver.py` | `resolve_names()` ‚Äî –ø–æ–∏—Å–∫ –∞–ª–∏–∞—Å–æ–≤ + fuzzy-–ø–æ–∏—Å–∫ –≤ –ë–î |
| `bot/admin.py` | Inline-–∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ–¥–æ–±—Ä–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è |

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö

- **`ai/qa.py`**: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è `resolve_names()`, `store.find_rules()`, `extract_rule()` –≤ pipeline
- **`bot/telegram.py`**: callback-—Ö—ç–Ω–¥–ª–µ—Ä—ã –¥–ª—è inline-–∫–Ω–æ–ø–æ–∫, –∫–æ–º–∞–Ω–¥–∞ `/rules`
- **`supabase_client.py`**: CRUD –¥–ª—è `knowledge_rules` –∏ `name_aliases`

---

## –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π Q&A pipeline

```
–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    ‚Üì
resolve_names() ‚Äî –ø–æ–¥–º–µ–Ω–∞ –∞–ª–∏–∞—Å–æ–≤ –∏–∑ –∫–µ—à–∞
    ‚Üì
store.find_rules(question) ‚Äî keyword matching
    ‚Üì
Claude: SQL generation (system prompt + matched rules + alias hints)
    ‚Üì
Execute SQL
    ‚Üì
[–µ—Å–ª–∏ 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ + –µ—Å—Ç—å –∏–º–µ–Ω–∞] ‚Üí fuzzy search –≤ –ë–î ‚Üí —Å–ø—Ä–æ—Å–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    ‚Üì
Claude: Answer generation
    ‚Üì
[–µ—Å–ª–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤–æ–ø—Ä–æ—Å –≤ —Å–µ—Å—Å–∏–∏] ‚Üí extract_rule() ‚Üí –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω—É
```
